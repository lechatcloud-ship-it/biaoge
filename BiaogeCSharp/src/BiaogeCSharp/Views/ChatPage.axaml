<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BiaogeCSharp.ViewModels"
             xmlns:converters="using:BiaogeCSharp.Converters"
             xmlns:md="https://github.com/whistyun/Markdown.Avalonia"
             xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="BiaogeCSharp.Views.ChatPage"
             x:DataType="vm:ChatViewModel">

    <Design.DataContext>
        <vm:ChatViewModel />
    </Design.DataContext>

    <UserControl.Resources>
        <converters:SendButtonTextConverter x:Key="SendButtonTextConverter" />
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- 用户消息气泡样式 -->
        <Style Selector="Border.user-message">
            <Setter Property="Background" Value="#0084FF" />
            <Setter Property="CornerRadius" Value="18" />
            <Setter Property="Padding" Value="16,10" />
            <Setter Property="Margin" Value="60,4,8,4" />
            <Setter Property="HorizontalAlignment" Value="Right" />
            <Setter Property="MaxWidth" Value="600" />
        </Style>

        <!-- AI消息气泡样式 -->
        <Style Selector="Border.assistant-message">
            <Setter Property="Background" Value="#F0F0F0" />
            <Setter Property="CornerRadius" Value="18" />
            <Setter Property="Padding" Value="16,10" />
            <Setter Property="Margin" Value="8,4,60,4" />
            <Setter Property="HorizontalAlignment" Value="Left" />
            <Setter Property="MaxWidth" Value="600" />
        </Style>

        <!-- 用户消息文本样式 -->
        <Style Selector="TextBlock.user-text">
            <Setter Property="Foreground" Value="White" />
            <Setter Property="TextWrapping" Value="Wrap" />
            <Setter Property="FontSize" Value="14" />
        </Style>

        <!-- AI消息文本样式 -->
        <Style Selector="TextBlock.assistant-text">
            <Setter Property="Foreground" Value="#1A1A1A" />
            <Setter Property="TextWrapping" Value="Wrap" />
            <Setter Property="FontSize" Value="14" />
        </Style>

        <!-- 时间戳样式 -->
        <Style Selector="TextBlock.timestamp">
            <Setter Property="Foreground" Value="#888888" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="Margin" Value="0,2,0,0" />
            <Setter Property="Opacity" Value="0.7" />
        </Style>

        <!-- 输入框样式 -->
        <Style Selector="TextBox.chat-input">
            <Setter Property="Background" Value="#F8F8F8" />
            <Setter Property="BorderBrush" Value="#E0E0E0" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="20" />
            <Setter Property="Padding" Value="16,10" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="MinHeight" Value="44" />
            <Setter Property="MaxHeight" Value="120" />
        </Style>

        <!-- 发送按钮样式 -->
        <Style Selector="Button.send-button">
            <Setter Property="Background" Value="#0084FF" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="CornerRadius" Value="20" />
            <Setter Property="Padding" Value="20,10" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="MinWidth" Value="80" />
            <Setter Property="MinHeight" Value="44" />
        </Style>

        <Style Selector="Button.send-button:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#0073E6" />
        </Style>

        <Style Selector="Button.send-button:disabled /template/ ContentPresenter">
            <Setter Property="Background" Value="#CCCCCC" />
        </Style>

        <!-- 工具按钮样式 -->
        <Style Selector="Button.tool-button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="#E0E0E0" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="12,6" />
            <Setter Property="FontSize" Value="13" />
        </Style>

        <Style Selector="Button.tool-button:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#F0F0F0" />
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- 顶部工具栏 -->
        <Border Grid.Row="0"
                Background="#FAFAFA"
                BorderBrush="#E0E0E0"
                BorderThickness="0,0,0,1"
                Padding="16,12">
            <Grid ColumnDefinitions="*,Auto,Auto">
                <TextBlock Grid.Column="0"
                          Text="AI助手"
                          FontSize="16"
                          FontWeight="SemiBold"
                          VerticalAlignment="Center" />

                <Button Grid.Column="1"
                        Classes="tool-button"
                        Content="重新生成"
                        Command="{Binding RegenerateResponseCommand}"
                        IsEnabled="{Binding !IsSending}"
                        Margin="0,0,8,0" />

                <Button Grid.Column="2"
                        Classes="tool-button"
                        Content="清空对话"
                        Command="{Binding ClearChatCommand}"
                        IsEnabled="{Binding !IsSending}" />
            </Grid>
        </Border>

        <!-- 消息列表区域 -->
        <ScrollViewer Grid.Row="1"
                     Name="MessageScrollViewer"
                     Padding="16,16,16,0"
                     VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding Messages}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:ChatMessageItem">
                        <StackPanel Margin="0,8">
                            <!-- 用户消息 -->
                            <Border Classes="user-message"
                                   IsVisible="{Binding IsUser}">
                                <StackPanel>
                                    <TextBlock Classes="user-text"
                                              Text="{Binding Content}" />
                                    <TextBlock Classes="timestamp"
                                              Text="{Binding FormattedTime}"
                                              HorizontalAlignment="Right" />
                                </StackPanel>
                            </Border>

                            <!-- AI消息 -->
                            <Border Classes="assistant-message"
                                   IsVisible="{Binding IsAssistant}">
                                <StackPanel>
                                    <Grid ColumnDefinitions="Auto,*">
                                        <materialIcons:MaterialIcon Grid.Column="0"
                                                  Kind="RobotOutline"
                                                  Width="20"
                                                  Height="20"
                                                  Margin="0,0,8,0"
                                                  VerticalAlignment="Top" />

                                        <StackPanel Grid.Column="1">
                                            <!-- Markdown渲染的AI回复 -->
                                            <md:MarkdownScrollViewer Markdown="{Binding Content}"
                                                                    Background="Transparent"
                                                                    BorderThickness="0"
                                                                    Padding="0"
                                                                    VerticalScrollBarVisibility="Disabled"
                                                                    HorizontalScrollBarVisibility="Disabled" />

                                            <!-- 流式输出指示器 -->
                                            <TextBlock Text="正在输入..."
                                                      Foreground="#0084FF"
                                                      FontSize="11"
                                                      FontStyle="Italic"
                                                      Margin="0,4,0,0"
                                                      IsVisible="{Binding IsStreaming}" />

                                            <TextBlock Classes="timestamp"
                                                      Text="{Binding FormattedTime}"
                                                      HorizontalAlignment="Left" />
                                        </StackPanel>
                                    </Grid>

                                    <!-- 消息操作按钮 -->
                                    <StackPanel Orientation="Horizontal"
                                               Margin="0,8,0,0"
                                               Spacing="8"
                                               IsVisible="{Binding !IsStreaming}">
                                        <Button Content="复制"
                                               FontSize="11"
                                               Padding="8,4"
                                               Background="Transparent"
                                               BorderBrush="#D0D0D0"
                                               BorderThickness="1"
                                               CornerRadius="4"
                                               Command="{Binding $parent[UserControl].((vm:ChatViewModel)DataContext).CopyMessageCommand}"
                                               CommandParameter="{Binding}" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- 底部输入区域 -->
        <Border Grid.Row="2"
                Background="White"
                BorderBrush="#E0E0E0"
                BorderThickness="0,1,0,0"
                Padding="16">
            <Grid RowDefinitions="Auto,Auto">
                <!-- 状态栏 -->
                <TextBlock Grid.Row="0"
                          Text="{Binding StatusText}"
                          FontSize="12"
                          Foreground="#666666"
                          Margin="0,0,0,8"
                          IsVisible="{Binding IsSending}" />

                <!-- 输入框和发送按钮 -->
                <Grid Grid.Row="1" ColumnDefinitions="*,Auto">
                    <TextBox Grid.Column="0"
                            Classes="chat-input"
                            Text="{Binding InputText}"
                            Watermark="输入消息... (Shift+Enter换行，Enter发送)"
                            AcceptsReturn="True"
                            TextWrapping="Wrap"
                            IsEnabled="{Binding !IsSending}"
                            KeyDown="OnInputKeyDown"
                            Margin="0,0,12,0" />

                    <Button Grid.Column="1"
                           Classes="send-button"
                           Content="{Binding IsSending, Converter={StaticResource SendButtonTextConverter}}"
                           Command="{Binding SendMessageCommand}"
                           IsEnabled="{Binding !IsSending}" />
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>
