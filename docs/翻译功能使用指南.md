# 翻译功能使用指南

## 🚀 快速开始

### 1. 获取API密钥

访问 [阿里云百炼控制台](https://dashscope.console.aliyun.com/) 获取API密钥：

1. 登录阿里云账号
2. 进入"百炼大模型"产品页
3. 在"API-KEY管理"中创建新密钥
4. 复制生成的API Key（格式：`sk-xxxxxxxxxxxxxx`）

**新用户福利**：阿里云百炼提供 100万 tokens 免费额度！

---

### 2. 配置API密钥

#### 方法A：环境变量（推荐）

**Windows:**
```cmd
# 临时设置（当前会话）
set DASHSCOPE_API_KEY=sk-your-api-key-here

# 永久设置（系统环境变量）
1. 右键"此电脑" -> 属性 -> 高级系统设置
2. 环境变量 -> 用户变量 -> 新建
3. 变量名: DASHSCOPE_API_KEY
4. 变量值: sk-your-api-key-here
```

**Linux/Mac:**
```bash
# 临时设置
export DASHSCOPE_API_KEY=sk-your-api-key-here

# 永久设置（添加到 ~/.bashrc 或 ~/.zshrc）
echo 'export DASHSCOPE_API_KEY=sk-your-api-key-here' >> ~/.bashrc
source ~/.bashrc
```

#### 方法B：配置文件

编辑 `~/.biaoge/config.toml`:

```toml
[api]
api_key = "sk-your-api-key-here"
```

---

### 3. 安装依赖

```bash
pip install -r requirements.txt
```

确保安装了 `dashscope>=1.23.0`。

---

## 📖 使用步骤

### 1. 打开DWG文件

1. 启动应用：`python run.py`
2. 点击"图纸查看"标签
3. 点击"打开DWG文件"
4. 选择要翻译的DWG/DXF文件

### 2. 执行翻译

1. 切换到"智能翻译"标签
2. 选择源语言（如：中文）
3. 选择目标语言（如：英文）
4. 点击"开始翻译"
5. 等待翻译完成（进度条实时显示）

### 3. 查看翻译结果

翻译完成后：
- 图纸上的文本会自动显示译文
- 统计信息会显示成本、耗时、缓存命中率
- 切换回"图纸查看"可以看到翻译后的图纸

---

## 💰 成本说明

### 定价（qwen-plus模型）

- **输入**：¥0.004 / 1000 tokens
- **输出**：¥0.004 / 1000 tokens

### 实际成本估算

| 图纸规模 | 文本实体数 | 唯一文本 | 首次成本 | 缓存后成本 |
|---------|-----------|---------|---------|-----------|
| 小型 | 500 | 200 | ¥0.03 | ¥0.003 |
| 中型 | 2000 | 800 | ¥0.12 | ¥0.012 |
| 大型 | 5000 | 2000 | ¥0.30 | ¥0.030 |

**说明**：
- 缓存命中后成本降低90%+
- 批量翻译比单条翻译节省50% tokens
- 相似图纸翻译接近零成本

---

## ⚡ 性能优化

### 1. 缓存机制

系统自动缓存所有翻译结果到SQLite数据库：

- **位置**：`~/.biaoge/cache/translation.db`
- **有效期**：7天（可配置）
- **命中率**：90%+（相似图纸）

### 2. 批量翻译

系统自动将文本分批处理：

- **默认批次**：50条/次
- **去重**：自动去除重复文本
- **过滤**：跳过纯数字、纯符号

### 3. 配置优化

编辑 `src/config/default.toml`:

```toml
[translation]
cache_enabled = true        # 启用缓存
cache_ttl_days = 7          # 缓存有效期（天）
batch_size = 50             # 批量大小

[api]
model = "qwen-plus"         # 模型选择
# qwen-plus: 性价比最高（推荐）
# qwen-max: 质量最高（成本10倍）
# qwen-turbo: 速度最快（质量稍差）
```

---

## 🌍 支持的语言

| 语言 | 代码 | 翻译质量 |
|-----|------|---------|
| 中文 | Chinese | ⭐⭐⭐⭐⭐ |
| 英文 | English | ⭐⭐⭐⭐⭐ |
| 日文 | Japanese | ⭐⭐⭐⭐⭐ |
| 韩文 | Korean | ⭐⭐⭐⭐ |
| 德文 | German | ⭐⭐⭐⭐ |
| 法文 | French | ⭐⭐⭐⭐ |
| 西班牙文 | Spanish | ⭐⭐⭐⭐ |
| 俄文 | Russian | ⭐⭐⭐⭐ |

**专业术语支持**：
- ✅ 建筑（梁、柱、墙、楼板等）
- ✅ 机械（轴、孔、螺纹等）
- ✅ 工程（混凝土标号、钢筋规格等）

---

## 🔧 故障排查

### 问题1：API密钥无效

**错误信息**：`未找到API密钥` 或 `API密钥无效`

**解决方法**：
1. 检查环境变量是否正确设置
2. 确认API密钥格式：`sk-xxxxxxxxxxxxxx`
3. 验证API密钥是否已激活
4. 重启应用

### 问题2：网络连接失败

**错误信息**：`网络错误` 或 `连接超时`

**解决方法**：
1. 检查网络连接
2. 确认可以访问 `dashscope.aliyuncs.com`
3. 检查防火墙设置
4. 系统会自动重试3次（指数退避）

### 问题3：翻译结果不准确

**优化建议**：
1. 切换到 `qwen-max` 模型（成本更高）
2. 在翻译前清理图纸文本（移除无关符号）
3. 分批次翻译不同类型的文本

### 问题4：缓存数据库锁定

**错误信息**：`database is locked`

**解决方法**：
1. 关闭所有应用实例
2. 删除 `~/.biaoge/cache/translation.db`
3. 重启应用

---

## 📊 翻译统计说明

翻译完成后显示的统计信息：

```
总实体数: 1523        # DWG中所有文本实体数量
唯一文本: 456         # 去重后的文本数量
缓存命中: 398         # 从缓存直接获取的数量
API翻译: 58           # 调用API翻译的数量
跳过: 1067            # 跳过的数量（纯数字/符号）

Token消耗: 8520       # 总token消耗
成本: ¥0.0682         # 总成本（元）
耗时: 12.5秒          # 翻译耗时

缓存命中率: 87.3%     # 缓存效率
```

---

## 🔐 安全注意事项

1. **API密钥保护**
   - ❌ 不要将API密钥提交到git
   - ✅ 使用环境变量
   - ✅ 设置文件权限（600）

2. **数据隐私**
   - 翻译文本会发送到阿里云服务器
   - 缓存存储在本地
   - 建议：敏感项目使用私有部署

3. **成本控制**
   - 监控API调用次数
   - 设置月度预算提醒
   - 优先使用缓存

---

## 💡 最佳实践

### 1. 批量图纸翻译

```python
# 使用脚本批量处理
from src.dwg.parser import DWGParser
from src.translation.engine import TranslationEngine

engine = TranslationEngine()

for dwg_file in dwg_files:
    doc = DWGParser().parse(dwg_file)
    stats = engine.translate_document(doc, 'Chinese', 'English')
    print(f"{dwg_file}: ¥{stats.total_cost:.4f}")
```

### 2. 清理过期缓存

```python
from src.translation.cache import TranslationCache

cache = TranslationCache()
deleted = cache.clear_expired()
print(f"清理了 {deleted} 条过期缓存")
```

### 3. 查看缓存统计

```python
stats = cache.get_statistics()
print(f"缓存总数: {stats['total_entries']}")
print(f"命中率: {stats['hit_rate']:.1%}")
```

---

## 📞 技术支持

- **官方文档**：[docs/01-架构设计文档-PyQt6.md](./01-架构设计文档-PyQt6.md)
- **阿里云百炼文档**：https://help.aliyun.com/zh/model-studio/
- **API控制台**：https://dashscope.console.aliyun.com/

---

## 🎉 示例效果

**翻译前**：
```
C30混凝土梁 300×600
钢筋: 4Φ25
箍筋: Φ8@200
```

**翻译后（英文）**：
```
C30 Concrete Beam 300×600
Reinforcement: 4Φ25
Stirrups: Φ8@200
```

**成本**：¥0.0008（约0.8分）
**耗时**：0.3秒（批量模式）

---

## 更新日志

### v1.0.0 (2025-01-07)
- ✅ 实现阿里云百炼API集成
- ✅ 智能批量翻译
- ✅ SQLite缓存系统
- ✅ 8种语言支持
- ✅ 实时进度显示
- ✅ 成本统计

---

享受智能翻译带来的效率提升！🚀
