# DWG智能翻译算量系统 - 技术选型与最佳实践

## 文档信息
- **项目名称**: DWG智能翻译算量系统
- **版本**: v1.0
- **创建日期**: 2025-11-07
- **最后更新**: 2025-11-07

---

## 1. 技术选型概览

### 1.1 选型原则
1. **性能优先**: 优先选择性能优秀的技术方案
2. **生态成熟**: 选择社区活跃、文档完善的技术
3. **安全可靠**: 重视安全性和稳定性
4. **可维护性**: 代码清晰、易于维护
5. **成本控制**: 在满足需求的前提下控制成本

### 1.2 技术栈总览

```
┌──────────────────────────────────────────────────┐
│                   用户界面层                      │
│   React 18 + TypeScript + Ant Design 5.x        │
└──────────────────────────────────────────────────┘
                      ↕
┌──────────────────────────────────────────────────┐
│                  应用框架层                       │
│            Tauri 2.0 (IPC Bridge)               │
└──────────────────────────────────────────────────┘
                      ↕
┌──────────────────────────────────────────────────┐
│                   业务逻辑层                      │
│  Rust (DWG解析、翻译、算量、导出)               │
└──────────────────────────────────────────────────┘
                      ↕
┌──────────────────────────────────────────────────┐
│                   数据存储层                      │
│       SQLite (缓存) + 文件系统 (配置)            │
└──────────────────────────────────────────────────┘
                      ↕
┌──────────────────────────────────────────────────┐
│                  外部服务层                       │
│         阿里云百炼API (大模型服务)               │
└──────────────────────────────────────────────────┘
```

---

## 2. 桌面应用框架选型

### 2.1 候选方案对比

| 维度 | Tauri 2.0 | Electron | Flutter Desktop | Qt |
|------|-----------|----------|-----------------|-----|
| **应用体积** | ⭐⭐⭐⭐⭐ (~3MB) | ⭐⭐ (~150MB) | ⭐⭐⭐ (~30MB) | ⭐⭐⭐⭐ (~15MB) |
| **内存占用** | ⭐⭐⭐⭐⭐ (~100MB) | ⭐⭐ (~200MB+) | ⭐⭐⭐ (~150MB) | ⭐⭐⭐⭐ (~80MB) |
| **启动速度** | ⭐⭐⭐⭐⭐ (<1s) | ⭐⭐⭐ (~2s) | ⭐⭐⭐⭐ (~1.5s) | ⭐⭐⭐⭐⭐ (<1s) |
| **开发效率** | ⭐⭐⭐⭐ (Web技术) | ⭐⭐⭐⭐⭐ (成熟) | ⭐⭐⭐ (Dart) | ⭐⭐⭐ (C++) |
| **跨平台** | ⭐⭐⭐⭐⭐ (5平台) | ⭐⭐⭐⭐⭐ (3平台) | ⭐⭐⭐⭐⭐ (6平台) | ⭐⭐⭐⭐⭐ (多平台) |
| **生态系统** | ⭐⭐⭐⭐ (快速成长) | ⭐⭐⭐⭐⭐ (最成熟) | ⭐⭐⭐⭐ (移动优先) | ⭐⭐⭐⭐⭐ (老牌) |
| **安全性** | ⭐⭐⭐⭐⭐ (原生) | ⭐⭐⭐ (Node.js) | ⭐⭐⭐⭐ (AOT编译) | ⭐⭐⭐⭐⭐ (原生) |
| **热更新** | ⭐⭐⭐⭐ (支持) | ⭐⭐⭐⭐⭐ (成熟) | ⭐⭐⭐ (有限) | ⭐⭐ (受限) |
| **Web技术** | ⭐⭐⭐⭐⭐ (原生支持) | ⭐⭐⭐⭐⭐ (Chromium) | ⭐⭐ (需插件) | ⭐⭐⭐ (WebView) |
| **学习曲线** | ⭐⭐⭐⭐ (需学Rust) | ⭐⭐⭐⭐⭐ (纯JS) | ⭐⭐⭐ (Dart+Flutter) | ⭐⭐ (C++复杂) |

### 2.2 最终选择：Tauri 2.0

**选择理由**:
1. ✅ **轻量高效**: 应用体积仅3-5MB，内存占用比Electron低50%+
2. ✅ **安全性强**: 使用系统原生WebView，Rust后端安全性高
3. ✅ **跨平台优秀**: 2.0版本支持桌面(Windows/macOS/Linux) + 移动端(iOS/Android)
4. ✅ **Web技术友好**: 前端使用React/Vue等主流框架，开发效率高
5. ✅ **Rust性能**: 后端使用Rust，非常适合DWG解析等CPU密集型任务
6. ✅ **2025年趋势**: Tauri是当前最受欢迎的Electron替代方案

**权衡考虑**:
- ⚠️ 需要团队学习Rust（但核心逻辑可复用，学习成本可接受）
- ⚠️ 生态相对Electron较新（但2.0版本已经很成熟）

**技术版本**:
- Tauri: v2.0+
- Rust: 1.75+
- Node.js: 20.x LTS

---

## 3. DWG解析技术选型

### 3.1 候选方案对比

| 方案 | 技术 | 优点 | 缺点 | 成本 |
|------|------|------|------|------|
| **libredwg** | C库 (开源) | 功能完整、免费 | 需FFI调用 | 免费 |
| **libredwg-web** | WASM (开源) | 浏览器可用 | 性能略低 | 免费 |
| **Aspose.CAD** | 商业SDK | 功能强大、支持好 | 昂贵授权费 | $$$$ |
| **ODA Drawings SDK** | 商业SDK | 官方支持 | 授权费高 | $$$$ |
| **自研解析器** | Rust实现 | 完全可控 | 开发成本高 | 时间成本 |

### 3.2 最终选择：libredwg + Rust FFI

**技术方案**:
```rust
// 使用 libredwg-sys crate (Rust bindings)
use libredwg_sys::*;

pub struct DwgParser {
    dwg: *mut Dwg_Data,
}

impl DwgParser {
    pub fn parse(path: &str) -> Result<DwgDocument, Error> {
        unsafe {
            let mut error: c_int = 0;
            let dwg = dwg_read_file(
                CString::new(path)?.as_ptr(),
                &mut error as *mut c_int
            );

            if dwg.is_null() {
                return Err(Error::ParseFailed(error));
            }

            // 提取实体...
            let document = Self::extract_entities(dwg);

            dwg_free(dwg);
            Ok(document)
        }
    }
}
```

**选择理由**:
1. ✅ **开源免费**: GNU LGPL授权，商业可用
2. ✅ **格式支持全**: R13 - R2024全覆盖
3. ✅ **性能优秀**: C语言实现，速度快
4. ✅ **Rust集成**: 有成熟的Rust bindings
5. ✅ **社区活跃**: 持续维护更新

**备选方案**: 如未来需要商业支持，可考虑Aspose.CAD（支持预算充足时）

---

## 4. 前端技术选型

### 4.1 UI框架选择：React 18

**选择理由**:
1. ✅ **生态最成熟**: NPM包最丰富
2. ✅ **性能优秀**: Fiber架构、并发模式
3. ✅ **TypeScript友好**: 类型支持完善
4. ✅ **团队熟悉**: 主流框架，招聘容易
5. ✅ **Tauri官方推荐**: 官方示例使用React

**技术栈**:
```json
{
  "react": "^18.2.0",
  "react-dom": "^18.2.0",
  "typescript": "^5.3.0",
  "vite": "^5.0.0"
}
```

### 4.2 UI组件库：Ant Design 5.x

**选择理由**:
1. ✅ **企业级UI**: 组件丰富、设计专业
2. ✅ **中文友好**: 国内团队开发，中文文档完善
3. ✅ **TypeScript原生**: 完整类型定义
4. ✅ **桌面适配**: 适合桌面应用场景
5. ✅ **主题定制**: 支持深色模式等

**核心组件**:
- Layout: 布局框架
- Tree: 图层树
- Table: 算量清单表格
- Form: 配置表单
- Modal: 对话框
- Drawer: 侧边栏
- Progress: 进度条
- Message/Notification: 消息提示

### 4.3 状态管理：Zustand

**对比其他方案**:
| 方案 | 优点 | 缺点 | 包大小 |
|------|------|------|--------|
| **Zustand** | 简单、轻量 | 生态较小 | 3.5KB |
| Redux Toolkit | 功能强大 | 样板代码多 | 15KB |
| MobX | 响应式 | 学习曲线 | 16KB |
| Jotai | 原子化 | 较新 | 4KB |

**选择Zustand**:
```typescript
import create from 'zustand';

interface AppState {
  document: DwgDocument | null;
  translationProgress: number;
  setDocument: (doc: DwgDocument) => void;
  updateProgress: (progress: number) => void;
}

export const useAppStore = create<AppState>((set) => ({
  document: null,
  translationProgress: 0,
  setDocument: (doc) => set({ document: doc }),
  updateProgress: (progress) => set({ translationProgress: progress }),
}));
```

**理由**:
- ✅ 极简API，无样板代码
- ✅ 性能优秀（基于Hook）
- ✅ TypeScript支持好
- ✅ 体积小（3.5KB gzipped）

### 4.4 图纸渲染：Three.js + Konva.js

**渲染方案选择**:

| 技术 | 用途 | 优点 | 适用场景 |
|------|------|------|----------|
| **Three.js** | 3D渲染 | WebGL性能强 | 3D图纸、复杂模型 |
| **Konva.js** | 2D渲染 | Canvas 2D、API友好 | 平面图、简单图形 |
| SVG | 矢量图 | 缩放不失真 | 静态展示 |
| Pixi.js | 2D游戏引擎 | 性能极高 | 复杂动画 |

**组合使用**:
```typescript
// 2D平面图使用 Konva
import Konva from 'konva';

class DwgRenderer2D {
  private stage: Konva.Stage;
  private layer: Konva.Layer;

  render(entities: Entity[]): void {
    entities.forEach(entity => {
      switch (entity.type) {
        case 'LINE':
          this.renderLine(entity);
          break;
        case 'CIRCLE':
          this.renderCircle(entity);
          break;
        case 'TEXT':
          this.renderText(entity);
          break;
      }
    });
    this.layer.draw();
  }

  private renderLine(entity: LineEntity): void {
    const line = new Konva.Line({
      points: [entity.start.x, entity.start.y, entity.end.x, entity.end.y],
      stroke: entity.color,
      strokeWidth: entity.lineWidth,
    });
    this.layer.add(line);
  }
}

// 3D模型使用 Three.js
import * as THREE from 'three';

class DwgRenderer3D {
  private scene: THREE.Scene;
  private camera: THREE.PerspectiveCamera;
  private renderer: THREE.WebGLRenderer;

  render(entities: Entity3D[]): void {
    entities.forEach(entity => {
      const geometry = this.createGeometry(entity);
      const material = new THREE.MeshBasicMaterial({ color: entity.color });
      const mesh = new THREE.Mesh(geometry, material);
      this.scene.add(mesh);
    });
    this.renderer.render(this.scene, this.camera);
  }
}
```

---

## 5. 大模型服务选型

### 5.1 阿里云百炼 vs 其他方案

| 服务商 | 模型 | 价格 (每百万tokens) | 优点 | 缺点 |
|--------|------|---------------------|------|------|
| **阿里云百炼** | Qwen-Plus | ¥4 | 性价比高、中文强 | 仅国内可用 |
| OpenAI | GPT-4 Turbo | $10 | 能力最强 | 价格高、需科学上网 |
| Anthropic | Claude 3 | $8 | 安全性好 | 国内不可用 |
| 智谱AI | GLM-4 | ¥5 | 国产、便宜 | 能力略弱 |
| 百度文心 | ERNIE 4.0 | ¥6 | 生态丰富 | API体验一般 |

### 5.2 最终选择：阿里云百炼

**模型选择**:
- **主力模型**: Qwen-Plus（性价比最优）
- **高精度场景**: Qwen-Max（算量识别等）
- **低延迟场景**: Qwen-Flash（实时预览）

**API调用方案**:
```typescript
import axios from 'axios';

interface BailianConfig {
  apiKey: string;
  endpoint: string;
  model: 'qwen-plus' | 'qwen-max' | 'qwen-flash';
}

class BailianClient {
  private config: BailianConfig;
  private retryCount = 3;
  private timeout = 60000;

  async complete(request: CompletionRequest): Promise<CompletionResponse> {
    for (let i = 0; i < this.retryCount; i++) {
      try {
        const response = await axios.post(
          `${this.config.endpoint}/services/aigc/text-generation/generation`,
          {
            model: request.model,
            input: { messages: request.messages },
            parameters: {
              temperature: request.temperature ?? 0.3,
              max_tokens: request.max_tokens ?? 2000,
            },
          },
          {
            headers: {
              'Authorization': `Bearer ${this.config.apiKey}`,
              'Content-Type': 'application/json',
            },
            timeout: this.timeout,
          }
        );

        return this.parseResponse(response.data);
      } catch (error) {
        if (i === this.retryCount - 1) throw error;
        await this.sleep(Math.pow(2, i) * 1000); // 指数退避
      }
    }
  }

  private async sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

**选择理由**:
1. ✅ **性价比**: Qwen-Plus仅¥4/百万tokens，比GPT-4便宜60%
2. ✅ **中文能力**: 建筑术语翻译更准确
3. ✅ **合规性**: 国内服务，无需科学上网
4. ✅ **免费额度**: 新用户100万tokens免费
5. ✅ **速度快**: 国内延迟低（<500ms）

---

## 6. 数据存储选型

### 6.1 本地数据库：SQLite

**选择理由**:
- ✅ **无需服务器**: 嵌入式数据库
- ✅ **轻量级**: 单个文件，易于备份
- ✅ **跨平台**: 所有平台支持
- ✅ **Rust支持**: rusqlite crate成熟

**使用场景**:
1. 翻译缓存（避免重复翻译）
2. 算量规则库
3. 项目历史记录
4. 用户偏好设置

**Rust集成**:
```rust
use rusqlite::{Connection, Result};

pub struct CacheDb {
    conn: Connection,
}

impl CacheDb {
    pub fn new(path: &str) -> Result<Self> {
        let conn = Connection::open(path)?;
        conn.execute(
            "CREATE TABLE IF NOT EXISTS translation_cache (
                id INTEGER PRIMARY KEY,
                source_text TEXT NOT NULL,
                target_text TEXT NOT NULL,
                source_lang TEXT,
                target_lang TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(source_text, source_lang, target_lang)
            )",
            [],
        )?;
        Ok(Self { conn })
    }

    pub fn get_translation(&self, text: &str, from: &str, to: &str) -> Result<Option<String>> {
        self.conn.query_row(
            "SELECT target_text FROM translation_cache
             WHERE source_text = ?1 AND source_lang = ?2 AND target_lang = ?3",
            [text, from, to],
            |row| row.get(0),
        ).optional()
    }

    pub fn set_translation(&self, text: &str, translation: &str, from: &str, to: &str) -> Result<()> {
        self.conn.execute(
            "INSERT OR REPLACE INTO translation_cache
             (source_text, target_text, source_lang, target_lang)
             VALUES (?1, ?2, ?3, ?4)",
            [text, translation, from, to],
        )?;
        Ok(())
    }
}
```

### 6.2 配置文件：TOML

**选择理由**:
- ✅ 人类可读
- ✅ 注释友好
- ✅ Rust原生支持（serde）

**示例配置**:
```toml
# ~/.biaoge/config.toml

[api]
provider = "aliyun-bailian"
model = "qwen-plus"
timeout = 60
max_retries = 3

[translation]
cache_enabled = true
cache_ttl_days = 7
batch_size = 100

[ui]
theme = "auto"
language = "zh-CN"
font_size = "medium"

[paths]
projects_dir = "~/Documents/BiaoGe"
temp_dir = "/tmp/biaoge"
```

---

## 7. 开发工具链

### 7.1 构建工具：Vite 5.x

**选择理由**:
- ✅ 极快的冷启动（ESM）
- ✅ 热更新（HMR）体验好
- ✅ Tauri官方推荐
- ✅ TypeScript原生支持

**配置示例**:
```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  clearScreen: false,
  server: {
    port: 1420,
    strictPort: true,
  },
  envPrefix: ['VITE_', 'TAURI_'],
  build: {
    target: ['es2021', 'chrome100', 'safari13'],
    minify: !process.env.TAURI_DEBUG ? 'esbuild' : false,
    sourcemap: !!process.env.TAURI_DEBUG,
  },
});
```

### 7.2 代码质量工具

**ESLint + Prettier**:
```json
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react/recommended",
    "plugin:react-hooks/recommended",
    "prettier"
  ],
  "plugins": ["@typescript-eslint", "react", "react-hooks"],
  "rules": {
    "react/react-in-jsx-scope": "off",
    "@typescript-eslint/no-explicit-any": "warn"
  }
}
```

**Rust工具链**:
- rustfmt: 代码格式化
- clippy: 代码检查
- cargo-audit: 依赖安全检查

### 7.3 测试框架

**前端测试**:
- **单元测试**: Vitest（Vite原生）
- **组件测试**: React Testing Library
- **E2E测试**: Playwright

**后端测试**:
```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_dwg_parser() {
        let parser = DwgParser::new();
        let doc = parser.parse("test.dwg").unwrap();
        assert_eq!(doc.entities.len(), 100);
    }

    #[tokio::test]
    async fn test_translation_api() {
        let client = BailianClient::new(test_config());
        let result = client.translate("承重墙", "zh", "en").await.unwrap();
        assert_eq!(result, "Load-bearing Wall");
    }
}
```

---

## 8. 性能优化最佳实践

### 8.1 DWG解析优化

**策略1: 流式解析**
```rust
// 不要一次性加载全部实体
pub fn parse_dwg_streaming(path: &str) -> impl Stream<Item = Entity> {
    // 使用异步流逐个返回实体
    stream! {
        let dwg = open_dwg(path);
        for entity in dwg.entities() {
            yield parse_entity(entity);
        }
    }
}
```

**策略2: 空间索引**
```rust
use rstar::RTree;

pub struct SpatialIndex {
    rtree: RTree<EntityBounds>,
}

impl SpatialIndex {
    pub fn query_region(&self, bbox: BoundingBox) -> Vec<&Entity> {
        self.rtree.locate_in_envelope(&bbox.to_envelope())
            .map(|e| e.entity)
            .collect()
    }
}
```

**策略3: 多线程**
```rust
use rayon::prelude::*;

pub fn parse_layers_parallel(layers: Vec<Layer>) -> Vec<ParsedLayer> {
    layers.par_iter()
        .map(|layer| parse_layer(layer))
        .collect()
}
```

### 8.2 渲染优化

**策略1: 视锥剔除**
```typescript
class Renderer {
  private visibleEntities: Entity[] = [];

  updateVisibleEntities(viewport: Viewport): void {
    this.visibleEntities = this.spatialIndex.query(viewport.bounds);
  }

  render(): void {
    this.visibleEntities.forEach(entity => this.renderEntity(entity));
  }
}
```

**策略2: LOD（细节层次）**
```typescript
interface LODConfig {
  level: number;
  minZoom: number;
  maxZoom: number;
  simplificationFactor: number;
}

const LOD_LEVELS: LODConfig[] = [
  { level: 0, minZoom: 0, maxZoom: 0.1, simplificationFactor: 10 },   // 超简化
  { level: 1, minZoom: 0.1, maxZoom: 0.5, simplificationFactor: 5 }, // 简化
  { level: 2, minZoom: 0.5, maxZoom: 2, simplificationFactor: 1 },   // 正常
  { level: 3, minZoom: 2, maxZoom: Infinity, simplificationFactor: 0.5 }, // 高精度
];
```

**策略3: Web Worker**
```typescript
// worker.ts
self.onmessage = (e) => {
  const { entities, viewport } = e.data;
  const visible = filterVisibleEntities(entities, viewport);
  self.postMessage(visible);
};

// main.ts
const worker = new Worker('worker.ts');
worker.postMessage({ entities, viewport });
worker.onmessage = (e) => {
  this.render(e.data);
};
```

### 8.3 翻译优化

**策略1: 批量 + 去重**
```typescript
class TranslationOptimizer {
  async translateBatch(texts: string[]): Promise<Map<string, string>> {
    // 1. 去重
    const uniqueTexts = [...new Set(texts)];

    // 2. 查缓存
    const cached = await this.checkCache(uniqueTexts);
    const toTranslate = uniqueTexts.filter(t => !cached.has(t));

    // 3. 批量翻译
    const translated = await this.batchTranslate(toTranslate);

    // 4. 合并结果
    return new Map([...cached, ...translated]);
  }
}
```

**策略2: 并发控制**
```typescript
import pLimit from 'p-limit';

const limit = pLimit(3); // 最多3个并发请求

const tasks = batches.map(batch =>
  limit(() => this.translateBatch(batch))
);

const results = await Promise.all(tasks);
```

---

## 9. 安全最佳实践

### 9.1 API密钥管理

**使用系统密钥链**:
```rust
use keyring::Entry;

pub fn store_api_key(key: &str) -> Result<(), Error> {
    let entry = Entry::new("biaoge", "bailian-api")?;
    entry.set_password(key)?;
    Ok(())
}

pub fn get_api_key() -> Result<String, Error> {
    let entry = Entry::new("biaoge", "bailian-api")?;
    Ok(entry.get_password()?)
}
```

### 9.2 Tauri安全配置

**tauri.conf.json**:
```json
{
  "tauri": {
    "allowlist": {
      "all": false,
      "fs": {
        "scope": ["$APPDATA/*", "$DOCUMENT/*"],
        "readFile": true,
        "writeFile": true
      },
      "dialog": {
        "open": true,
        "save": true
      },
      "http": {
        "scope": ["https://dashscope.aliyuncs.com/*"],
        "request": true
      }
    },
    "security": {
      "csp": "default-src 'self'; connect-src https://dashscope.aliyuncs.com"
    }
  }
}
```

### 9.3 输入验证

```typescript
// 验证文件路径
function validateFilePath(path: string): boolean {
  const allowedExtensions = ['.dwg', '.dxf'];
  const ext = path.toLowerCase().slice(path.lastIndexOf('.'));
  return allowedExtensions.includes(ext);
}

// 验证翻译输入
function sanitizeTranslationInput(text: string): string {
  // 移除潜在的注入代码
  return text
    .replace(/<script>/gi, '')
    .replace(/javascript:/gi, '')
    .trim();
}
```

---

## 10. 部署与发布

### 10.1 构建流程

```bash
# 开发模式
npm run tauri dev

# 生产构建
npm run tauri build

# 输出目录
# Windows: src-tauri/target/release/bundle/msi/
# macOS: src-tauri/target/release/bundle/dmg/
# Linux: src-tauri/target/release/bundle/appimage/
```

### 10.2 自动更新

**配置updater**:
```json
{
  "tauri": {
    "updater": {
      "active": true,
      "endpoints": [
        "https://releases.biaoge.com/{{target}}/{{current_version}}"
      ],
      "dialog": true,
      "pubkey": "YOUR_PUBLIC_KEY"
    }
  }
}
```

**更新检查**:
```typescript
import { checkUpdate, installUpdate } from '@tauri-apps/api/updater';
import { relaunch } from '@tauri-apps/api/process';

async function checkForUpdates() {
  const { shouldUpdate, manifest } = await checkUpdate();

  if (shouldUpdate) {
    const confirmed = await confirm(
      `发现新版本 ${manifest.version}，是否立即更新？`
    );

    if (confirmed) {
      await installUpdate();
      await relaunch();
    }
  }
}
```

### 10.3 代码签名

**Windows**:
```bash
# 使用 SignTool
signtool sign /f certificate.pfx /p password /tr http://timestamp.digicert.com app.exe
```

**macOS**:
```bash
# 使用 codesign
codesign --deep --force --verify --verbose --sign "Developer ID Application: YourName" app.app
```

---

## 11. 监控与日志

### 11.1 日志系统

```rust
use log::{info, warn, error};
use env_logger::Builder;

pub fn init_logger() {
    Builder::new()
        .filter_level(log::LevelFilter::Info)
        .format_timestamp_secs()
        .init();
}

// 使用
info!("DWG file loaded: {}", file_path);
warn!("Translation quota nearly exhausted: {}%", usage);
error!("Failed to parse DWG: {:?}", err);
```

### 11.2 性能监控

```typescript
class PerformanceMonitor {
  private metrics = new Map<string, number[]>();

  async measure<T>(name: string, fn: () => Promise<T>): Promise<T> {
    const start = performance.now();
    const result = await fn();
    const duration = performance.now() - start;

    this.record(name, duration);

    // 慢操作告警
    if (duration > 1000) {
      console.warn(`[SLOW] ${name} took ${duration}ms`);
    }

    return result;
  }

  getStats(name: string) {
    const values = this.metrics.get(name) || [];
    return {
      avg: values.reduce((a, b) => a + b, 0) / values.length,
      max: Math.max(...values),
      min: Math.min(...values),
      p95: this.percentile(values, 0.95),
    };
  }
}
```

---

## 12. 技术债务管理

### 12.1 已知限制

| 限制 | 当前方案 | 未来改进 |
|------|----------|----------|
| DWG R2024+支持 | 待libredwg更新 | 跟进社区进度 |
| 3D渲染性能 | 软件渲染 | 考虑WebGPU |
| 离线翻译 | 不支持 | 集成本地小模型 |
| 移动端支持 | 无 | Tauri 2.0已支持 |

### 12.2 技术演进路线

**Phase 1** (v1.0 - 2025 Q2):
- ✅ 基础功能实现
- ✅ DWG解析
- ✅ 在线翻译
- ✅ 基础算量

**Phase 2** (v1.5 - 2025 Q3):
- [ ] 性能优化
- [ ] 插件系统
- [ ] 高级算量（钢筋、管线）
- [ ] 移动端支持

**Phase 3** (v2.0 - 2025 Q4):
- [ ] AI辅助设计
- [ ] 云端协作
- [ ] 离线模式
- [ ] BIM集成

---

## 13. 总结

### 13.1 核心技术决策

| 分类 | 技术选择 | 理由 |
|------|----------|------|
| 应用框架 | Tauri 2.0 | 轻量、安全、跨平台 |
| DWG解析 | libredwg | 开源、完整、性能好 |
| UI框架 | React 18 | 生态成熟、团队熟悉 |
| UI组件 | Ant Design 5 | 企业级、中文友好 |
| 状态管理 | Zustand | 简单、轻量、够用 |
| 大模型 | 阿里云百炼 | 性价比高、中文强 |
| 数据库 | SQLite | 嵌入式、轻量 |
| 构建工具 | Vite 5 | 快速、现代 |

### 13.2 关键成功因素

1. **性能优先**: 所有技术选型都考虑了性能
2. **安全第一**: 使用Rust、系统密钥链等安全措施
3. **开发效率**: Web技术栈降低学习成本
4. **可扩展性**: 模块化设计便于迭代
5. **成本控制**: 优先选择开源方案

### 13.3 风险与应对

| 风险 | 应对措施 |
|------|----------|
| Rust学习曲线 | 团队培训、代码审查 |
| libredwg兼容性 | 充分测试、准备备选方案 |
| API成本超预算 | 缓存优化、用量监控 |
| 跨平台兼容性 | 持续集成测试 |

---

**文档结束**
